<html>
<head>
<title>tag.rb</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #bcbec4;}
.s1 { color: #bcbec4;}
.s2 { color: #6aab73;}
.s3 { color: #cf8e6d;}
.s4 { color: #fefff9;}
.s5 { color: #89a6af;}
.s6 { color: #c77dbb;}
.s7 { color: #808080; font-style: italic;}
.s8 { color: #74a4c8;}
.s9 { color: #cc7832;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
tag.rb</font>
</center></td></tr></table>
<pre><span class="s0">require_relative </span><span class="s2">'array'</span>

<span class="s3">class </span><span class="s4">Tag</span>
  <span class="s0">attr_reader </span><span class="s5">:label</span><span class="s0">, </span><span class="s5">:attributes</span><span class="s0">, </span><span class="s5">:children</span>

  <span class="s3">def self</span><span class="s0">.with_label(label)</span>
    <span class="s0">tag = </span><span class="s3">self</span><span class="s0">.new</span>
    <span class="s0">tag.with_label(label)</span>
  <span class="s3">end</span>

  <span class="s3">def self</span><span class="s0">.with_label_and_attributes(label, attributes)</span>
    <span class="s0">tag = </span><span class="s3">self</span><span class="s0">.with_label(label)</span>
    <span class="s0">tag.with_attributes(attributes)</span>
  <span class="s3">end</span>

  <span class="s3">def </span><span class="s0">initialize</span>
    <span class="s6">@attributes </span><span class="s0">= {}</span>
    <span class="s6">@children </span><span class="s0">= []</span>
  <span class="s3">end</span>

  <span class="s7"># Todos los with_x son setters.</span>

  <span class="s3">def </span><span class="s0">with_label(label)</span>
    <span class="s6">@label </span><span class="s0">= label</span>
    <span class="s3">self</span>
  <span class="s3">end</span>

  <span class="s3">def </span><span class="s0">with_attribute(label, value)</span>
    <span class="s0">label = label.to_s</span>
    <span class="s0">raise </span><span class="s2">&quot;La etiqueta </span><span class="s0">#{</span><span class="s3">self</span><span class="s0">.label} </span><span class="s2">ha quedado con dos o mas atributos con el mismo nombre: </span><span class="s0">#{label}</span><span class="s2">&quot; </span><span class="s3">if </span><span class="s6">@attributes</span><span class="s0">[label]</span>
    <span class="s6">@attributes</span><span class="s0">[label] = value</span>
    <span class="s3">self</span>
  <span class="s3">end</span>

  <span class="s3">def </span><span class="s0">with_attributes(attributes)</span>
    <span class="s0">attributes.each </span><span class="s3">do </span><span class="s0">|key, value|</span>
      <span class="s3">self</span><span class="s0">.with_attribute(key, value)</span>
    <span class="s3">end unless </span><span class="s0">attributes == </span><span class="s3">nil</span>

    <span class="s3">self</span>
  <span class="s3">end</span>

  <span class="s3">def </span><span class="s0">with_child(child)</span>
    <span class="s6">@children </span><span class="s0">&lt;&lt; child</span>
    <span class="s3">self</span>
  <span class="s3">end</span>

  <span class="s7"># Retorna recursivamente el xml generado.</span>

  <span class="s3">def </span><span class="s0">xml(level = </span><span class="s8">0</span><span class="s0">)</span>
    <span class="s3">if </span><span class="s6">@label</span>
      <span class="s3">if </span><span class="s0">children.empty?</span>
        <span class="s2">&quot;</span><span class="s0">#{</span><span class="s2">&quot;</span><span class="s9">\t</span><span class="s2">&quot; </span><span class="s0">* level}</span><span class="s2">&lt;</span><span class="s0">#{label}#{xml_attributes}</span><span class="s2">/&gt;&quot;</span>
      <span class="s3">else</span>
        <span class="s2">&quot;</span><span class="s0">#{</span><span class="s2">&quot;</span><span class="s9">\t</span><span class="s2">&quot; </span><span class="s0">* level}</span><span class="s2">&lt;</span><span class="s0">#{label}#{xml_attributes}</span><span class="s2">&gt;</span><span class="s9">\n</span><span class="s0">#{xml_children(level + </span><span class="s8">1</span><span class="s0">)}</span><span class="s9">\n</span><span class="s0">#{</span><span class="s2">&quot;</span><span class="s9">\t</span><span class="s2">&quot; </span><span class="s0">* level}</span><span class="s2">&lt;/</span><span class="s0">#{label}</span><span class="s2">&gt;&quot;</span>
      <span class="s3">end</span>
    <span class="s3">else</span>
      <span class="s2">&quot;&quot;</span>
    <span class="s3">end</span>
  <span class="s3">end</span>

  <span class="s0">private</span>

  <span class="s3">def </span><span class="s0">xml_children(level)</span>
    <span class="s3">self</span><span class="s0">.children.map </span><span class="s3">do </span><span class="s0">|child|</span>
      <span class="s3">if </span><span class="s0">child.is_a? </span><span class="s4">Tag</span>
        <span class="s0">child.xml(level)</span>
      <span class="s3">else</span>
        <span class="s0">xml_value(child, level)</span>
      <span class="s3">end</span>
    <span class="s3">end</span><span class="s0">.join(</span><span class="s2">&quot;</span><span class="s9">\n</span><span class="s2">&quot;</span><span class="s0">)</span>
  <span class="s3">end</span>

  <span class="s3">def </span><span class="s0">xml_attributes</span>
    <span class="s3">self</span><span class="s0">.attributes.map </span><span class="s3">do </span><span class="s0">|name, value|</span>
      <span class="s2">&quot;</span><span class="s0">#{name}</span><span class="s2">=</span><span class="s0">#{xml_value(value, </span><span class="s8">0</span><span class="s0">)}</span><span class="s2">&quot;</span>
    <span class="s3">end</span><span class="s0">.xml_join(</span><span class="s2">' '</span><span class="s0">)</span>
  <span class="s3">end</span>

  <span class="s3">def </span><span class="s0">xml_value(value, level)</span>
    <span class="s2">&quot;</span><span class="s9">\t</span><span class="s2">&quot; </span><span class="s0">* level + </span><span class="s3">if </span><span class="s0">value.is_a? </span><span class="s4">String</span>
                     <span class="s2">&quot;</span><span class="s9">\</span><span class="s2">&quot;</span><span class="s0">#{value}</span><span class="s9">\</span><span class="s2">&quot;&quot;</span>
                   <span class="s3">else</span>
                     <span class="s0">value.to_s</span>
                   <span class="s3">end</span>
  <span class="s3">end</span>

<span class="s3">end</span></pre>
</body>
</html>