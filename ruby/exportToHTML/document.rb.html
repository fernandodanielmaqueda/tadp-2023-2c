<html>
<head>
<title>document.rb</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #bcbec4;}
.s1 { color: #bcbec4;}
.s2 { color: #6aab73;}
.s3 { color: #cf8e6d;}
.s4 { color: #fefff9;}
.s5 { color: #89a6af;}
.s6 { color: #c77dbb;}
.s7 { color: #74a4c8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
document.rb</font>
</center></td></tr></table>
<pre><span class="s0">require_relative </span><span class="s2">'tag'</span>
<span class="s0">require_relative </span><span class="s2">'eval_xml_block'</span>

<span class="s3">class </span><span class="s4">Document</span>

  <span class="s0">attr_accessor </span><span class="s5">:root</span>
  <span class="s0">attr_reader </span><span class="s5">:parent</span>

  <span class="s3">def self</span><span class="s0">.with_root(tag)</span>
    <span class="s3">self</span><span class="s0">.new.root = tag</span>
  <span class="s3">end</span>

  <span class="s3">def </span><span class="s0">initialize(parent = </span><span class="s3">nil</span><span class="s0">, *xml_block_args, &amp;xml_block)</span>
    <span class="s6">@parent </span><span class="s0">= parent</span>

    <span class="s4">Eval_XML_Block</span><span class="s0">.new(</span><span class="s3">self</span><span class="s0">, *xml_block_args, &amp;xml_block) </span><span class="s3">if </span><span class="s0">xml_block</span>
  <span class="s3">end</span>

  <span class="s3">def </span><span class="s0">xml</span>
    <span class="s0">raise </span><span class="s2">&quot;El documento no tiene un tag raiz&quot; </span><span class="s3">unless </span><span class="s6">@root</span>

    <span class="s6">@root</span><span class="s0">.xml</span>
  <span class="s3">end</span>

  <span class="s3">def self</span><span class="s0">.serialize(parent = </span><span class="s3">nil</span><span class="s0">, tag_label = </span><span class="s3">nil</span><span class="s0">, object)</span>

    <span class="s3">if not </span><span class="s0">object.class.ignore?</span>
      <span class="s0">tag = </span><span class="s4">Tag</span><span class="s0">.with_label(tag_label || </span><span class="s3">self</span><span class="s0">.nombre_tag(object))</span>

      <span class="s3">if not </span><span class="s0">object.class.custom_proc</span>
        <span class="s0">attributes = </span><span class="s3">self</span><span class="s0">.atributos_de(object)</span>
        <span class="s3">self</span><span class="s0">.serializar_campos(tag, attributes, object)</span>
      <span class="s3">else</span>
        <span class="s3">self</span><span class="s0">.new(tag, object, &amp;object.class.custom_proc)</span>
      <span class="s3">end</span>

      <span class="s3">if </span><span class="s0">parent</span>
        <span class="s0">parent.with_child(tag)</span>
      <span class="s3">else</span>
        <span class="s3">self</span><span class="s0">.with_root(tag)</span>
      <span class="s3">end</span>

    <span class="s3">else</span>
      <span class="s3">self</span><span class="s0">.with_root(</span><span class="s4">Tag</span><span class="s0">.new)</span>
    <span class="s3">end</span>

  <span class="s3">end</span>

  <span class="s0">private</span>

  <span class="s3">def self</span><span class="s0">.nombre_tag(object)</span>
    <span class="s3">self</span><span class="s0">.etiqueta_de_la_clase_de(object) || </span><span class="s3">self</span><span class="s0">.nombre_en_minusculas_de_la_clase_de(object)</span>
  <span class="s3">end</span>

  <span class="s3">def self</span><span class="s0">.nombre_atributo(object, getter)</span>
    <span class="s3">self</span><span class="s0">.label_atributo(object, getter) || getter</span>
  <span class="s3">end</span>

  <span class="s3">def self</span><span class="s0">.label_atributo(object, getter)</span>
    <span class="s0">object.class.unbound_instance_methods[getter].label</span>
  <span class="s3">end</span>

  <span class="s3">def self</span><span class="s0">.etiqueta_de_la_clase_de(object)</span>
    <span class="s0">object.class.label</span>
  <span class="s3">end</span>

  <span class="s3">def self</span><span class="s0">.nombre_en_minusculas_de_la_clase_de(object)</span>
    <span class="s0">object.class.to_s.downcase</span>
  <span class="s3">end</span>

  <span class="s3">def self</span><span class="s0">.atributos_de(object)</span>
    <span class="s3">self</span><span class="s0">.atributos_sin_ignore(</span><span class="s3">self</span><span class="s0">.atributos_con_getter_de(object), object)</span>
  <span class="s3">end</span>

  <span class="s3">def self</span><span class="s0">.atributos_sin_ignore(attributes, object)</span>
    <span class="s0">attributes.filter </span><span class="s3">do </span><span class="s0">|getter|</span>
      <span class="s3">not </span><span class="s0">object.class.unbound_instance_methods[getter].ignore?</span>
    <span class="s3">end</span>
  <span class="s3">end</span>

  <span class="s3">def self</span><span class="s0">.atributos_con_getter_de(object)</span>
    <span class="s3">self</span><span class="s0">.simbolos_de_metodos_con_getter(</span><span class="s3">self</span><span class="s0">.simbolos_de_atributos_convertidos_a_simbolos_de_metodos_de(object), object)</span>
  <span class="s3">end</span>

  <span class="s3">def self</span><span class="s0">.simbolos_de_atributos_convertidos_a_simbolos_de_metodos_de(object)</span>
    <span class="s0">object.instance_variables.map </span><span class="s3">do </span><span class="s0">|instance_variable_symbol|</span>
      <span class="s0">instance_variable_symbol.to_s.sub(</span><span class="s2">&quot;@&quot;</span><span class="s0">, </span><span class="s2">&quot;&quot;</span><span class="s0">).to_sym</span>
    <span class="s3">end</span>
  <span class="s3">end</span>

  <span class="s3">def self</span><span class="s0">.simbolos_de_metodos_con_getter(method_symbols, object)</span>
    <span class="s0">method_symbols.filter </span><span class="s3">do </span><span class="s0">|method_symbol|</span>
      <span class="s0">object.methods.any? </span><span class="s3">do </span><span class="s0">|object_method|</span>
        <span class="s0">(method_symbol == object_method) </span><span class="s3">and </span><span class="s0">(object.method(object_method).arity == </span><span class="s7">0</span><span class="s0">)</span>
      <span class="s3">end</span>
    <span class="s3">end</span>
  <span class="s3">end</span>

  <span class="s3">def self</span><span class="s0">.serializar_campos(tag, attributes, object)</span>

    <span class="s0">attributes.each </span><span class="s3">do </span><span class="s0">|getter|</span>
      <span class="s0">value = object.send(getter)</span>
      <span class="s0">inline_proc = object.class.unbound_instance_methods[getter].inline_proc</span>

      <span class="s3">if </span><span class="s0">inline_proc</span>
        <span class="s3">self</span><span class="s0">.serializar_inline(inline_proc, </span><span class="s3">self</span><span class="s0">.nombre_atributo(object, getter), value, tag)</span>
      <span class="s3">elsif self</span><span class="s0">.representable_como_atributo_de_un_tag?(value)</span>
        <span class="s3">self</span><span class="s0">.serializar_atributo(tag, </span><span class="s3">self</span><span class="s0">.nombre_atributo(object, getter), value)</span>
      <span class="s3">else</span>
        <span class="s3">self</span><span class="s0">.serializar_tag(tag, </span><span class="s3">self</span><span class="s0">.label_atributo(object, getter), value)</span>
      <span class="s3">end</span>
    <span class="s3">end</span>

  <span class="s3">end</span>

  <span class="s3">def self</span><span class="s0">.representable_como_atributo_de_un_tag?(value)</span>
    <span class="s0">[</span><span class="s4">String</span><span class="s0">, </span><span class="s4">TrueClass</span><span class="s0">, </span><span class="s4">FalseClass</span><span class="s0">, </span><span class="s4">Numeric</span><span class="s0">, </span><span class="s4">NilClass</span><span class="s0">].any? {|class_element| value.is_a? class_element}</span>
  <span class="s3">end</span>

  <span class="s3">def self</span><span class="s0">.serializar_inline(inline_proc, label, value, tag)</span>
    <span class="s0">value = inline_proc.call(value)</span>
    <span class="s0">raise </span><span class="s2">&quot;Luego de aplicar el bloque de la anotacion Inline sobre el campo del atributo </span><span class="s0">#{label}</span><span class="s2">, el resultado no tiene un tipo representable como un atributo del tag </span><span class="s0">#{tag.label}</span><span class="s2">&quot; </span><span class="s3">unless </span><span class="s0">representable_como_atributo_de_un_tag?(value)</span>
    <span class="s3">self</span><span class="s0">.serializar_atributo(tag, label, value)</span>
  <span class="s3">end</span>

  <span class="s3">def self</span><span class="s0">.serializar_atributo(tag, label, value)</span>
    <span class="s0">tag.with_attribute(label, value)</span>
  <span class="s3">end</span>

  <span class="s3">def self</span><span class="s0">.serializar_tag(tag, label, value)</span>
    <span class="s3">if </span><span class="s0">value.is_a? </span><span class="s4">Array</span>
      <span class="s3">self</span><span class="s0">.serializar_tag_array(tag, label, value)</span>
    <span class="s3">else</span>
      <span class="s3">self</span><span class="s0">.serializar_tag_otro_objeto(tag, label, value)</span>
    <span class="s3">end</span>
  <span class="s3">end</span>

  <span class="s3">def self</span><span class="s0">.serializar_tag_array(tag, label, array)</span>
    <span class="s0">array.each </span><span class="s3">do </span><span class="s0">|object|</span>
      <span class="s3">self</span><span class="s0">.serialize(tag, label, object)</span>
    <span class="s3">end</span>
  <span class="s3">end</span>

  <span class="s3">def self</span><span class="s0">.serializar_tag_otro_objeto(tag, label, object)</span>
    <span class="s3">self</span><span class="s0">.serialize(tag, label, object)</span>
  <span class="s3">end</span>

<span class="s3">end</span></pre>
</body>
</html>